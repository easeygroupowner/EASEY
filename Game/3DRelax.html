<!DOCTYPE html>
<html lang="id">
  <head>
    <title>Calm Journey 3D â€” Smooth Edition</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <style>
      body {
        margin: 0;
        background: #e8f5e9;
        font-family: Segoe UI, sans-serif;
        overflow: hidden;
      }

      /* MENU */
      #menu {
        position: fixed;
        inset: 0;
        background: #c8e6c9;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }

      button {
        padding: 10px 25px;
        border: none;
        border-radius: 20px;
        font-size: 15px;
        background: #81c784;
        color: white;
        cursor: pointer;
      }

      /* HUD */
      #hud {
        display: none;
        position: fixed;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        background: white;
        padding: 10px 25px;
        border-radius: 20px;
        box-shadow: 0 5px 25px rgba(0, 0, 0, 0.1);
        font-size: 18px;
        transition: transform 0.3s ease, opacity 0.3s ease;
      }

      .animate {
        transform: translateX(-50%) scale(1.1);
        opacity: 0.9;
      }

      /* Breathing box */
      #breathBox {
        display: none;
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: white;
        padding: 12px 20px;
        border-radius: 20px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        font-size: 18px;
        opacity: 0.9;
      }

      /* ===== MUSIC MENU ===== */
      #musicMenu {
        position: fixed;
        right: 15px;
        bottom: 15px;
        background: white;
        padding: 10px 15px;
        border-radius: 15px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
        display: none;
      }

      #musicMenu button {
        padding: 6px 12px;
        border-radius: 12px;
      }

      /* ===== JOYSTICK ===== */
      #joystick {
        position: fixed;
        left: 15px;
        bottom: 15px;
        width: 120px;
        height: 120px;
        background: rgba(255, 255, 255, 0.5);
        border-radius: 50%;
        display: none;
        align-items: center;
        justify-content: center;
      }

      #stick {
        width: 55px;
        height: 55px;
        background: #81c784;
        border-radius: 50%;
        position: relative;
      }

      /* ===== TOP BUTTONS ===== */
      #topButtons {
        position: fixed;
        top: 10px;
        right: 10px;
        display: none;
        gap: 8px;
      }

      .topBtn {
        padding: 8px 15px;
        border: none;
        border-radius: 16px;
        background: #4caf50;
        color: white;
        cursor: pointer;
        font-size: 14px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .breathing {
        animation: breath 3s ease-in-out infinite;
      }

      @keyframes breath {
        0% {
          transform: translateX(-50%) scale(1);
        }
        50% {
          transform: translateX(-50%) scale(1.1);
        }
        100% {
          transform: translateX(-50%) scale(1);
        }
      }
    </style>
  </head>

  <body>
    <div id="menu">
      <h2>Calm Journey ðŸ§ </h2>
      <button onclick="startGame()">Mulai</button>
    </div>

    <div id="hud">
      Level: <span id="level">1</span> â€” Skor: <span id="score">0</span>
    </div>

    <div id="breathBox" class="breathing">Tarik napas perlahanâ€¦</div>

    <div id="musicMenu">
      <button id="musicToggle">Pause</button>
      <br /><br />
      Volume
      <input type="range" id="vol" min="0" max="1" step="0.05" value="0.4" />
    </div>

    <div id="joystick">
      <div id="stick"></div>
    </div>

    <div id="topButtons">
      <button class="topBtn" onclick="restartGame()">Restart</button>
      <button class="topBtn" onclick="goHome()">Home</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
      let scene, camera, renderer;
      let player;
      let orbs = [],
        decor = [],
        clouds = [];
      let score = 0,
        level = 1;
      let keys = {};

      let vel = new THREE.Vector3(0, 0, 0);
      const accel = 0.03;
      const friction = 0.85;

      let joyX = 0,
        joyY = 0;
      let lastTime = performance.now();

      const hud = document.getElementById("hud");
      const breathUI = document.getElementById("breathBox");
      const scoreUI = document.getElementById("score");
      const levelUI = document.getElementById("level");
      const musicMenu = document.getElementById("musicMenu");
      const joystick = document.getElementById("joystick");
      const stick = document.getElementById("stick");

      let music = new Audio("joyfull.mp3");
      music.loop = true;
      music.volume = 0.4;

      document.getElementById("musicToggle").onclick = () => {
        if (music.paused) {
          music.play();
          musicToggle.innerText = "Pause";
        } else {
          music.pause();
          musicToggle.innerText = "Play";
        }
      };

      document.getElementById("vol").oninput = (e) =>
        (music.volume = e.target.value);

      function startGame() {
        document.getElementById("menu").style.display = "none";
        hud.style.display = "block";
        breathUI.style.display = "block";
        musicMenu.style.display = "block";
        joystick.style.display = "flex";
        document.getElementById("topButtons").style.display = "flex";

        music.play();
        setupThree();
        spawnLevel();
        gameLoop();
        breathingGuide();
      }

      function restartGame() {
        fadeTransition(() => {
          score = 0;
          vel.set(0, 0, 0);
          player.position.set(0, 0.6, 0);
          spawnLevel();
        });
      }

      function goHome() {
        fadeTransition(() => {
          level = 1;
          score = 0;
          vel.set(0, 0, 0);

          document.getElementById("menu").style.display = "flex";
          hud.style.display = "none";
          breathUI.style.display = "none";
          musicMenu.style.display = "none";
          joystick.style.display = "none";
          document.getElementById("topButtons").style.display = "none";

          music.pause();
        });
      }

      function setupThree() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color("#dcedc8");

        camera = new THREE.PerspectiveCamera(
          75,
          innerWidth / innerHeight,
          0.1,
          1000
        );

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(innerWidth, innerHeight);
        document.body.appendChild(renderer.domElement);

        const light = new THREE.DirectionalLight(0xffffff, 1);
        light.position.set(5, 10, 5);
        scene.add(light);

        scene.add(new THREE.AmbientLight(0xffffff, 0.6));

        const body = new THREE.Mesh(
          new THREE.CylinderGeometry(0.3, 0.3, 1.2),
          new THREE.MeshPhongMaterial({ color: 0x4caf50 })
        );
        const head = new THREE.Mesh(
          new THREE.SphereGeometry(0.3),
          new THREE.MeshPhongMaterial({ color: 0xffecb3 })
        );

        head.position.y = 0.9;

        player = new THREE.Group();
        player.add(body);
        player.add(head);
        player.position.y = 0.6;
        scene.add(player);

        const ground = new THREE.Mesh(
          new THREE.PlaneGeometry(60, 60),
          new THREE.MeshPhongMaterial({ color: 0xc8e6c9 })
        );
        ground.rotation.x = -Math.PI / 2;
        scene.add(ground);

        camera.position.set(0, 2, 6);

        document.addEventListener("keydown", (e) => (keys[e.key] = true));
        document.addEventListener("keyup", (e) => (keys[e.key] = false));

        spawnClouds();
      }

      /* ===== JOYSTICK ===== */
      let joyActive = false,
        baseRect;

      // Fungsi bantuan untuk menangani awal sentuhan/klik
      const handleStart = (e) => {
        joyActive = true;
        baseRect = joystick.getBoundingClientRect();
        handleMove(e); // Langsung update posisi saat diklik
      };

      // Fungsi bantuan untuk menangani pergerakan
      const handleMove = (e) => {
        if (!joyActive) return;

        // Mengambil koordinat baik dari sentuhan (HP) maupun mouse (Desktop)
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;

        // 60 adalah setengah dari lebar joystick (120px / 2)
        let x = clientX - (baseRect.left + 60);
        let y = clientY - (baseRect.top + 60);

        const max = 45; // Batas radius gerak stick
        if (Math.hypot(x, y) > max) {
          let a = Math.atan2(y, x);
          x = Math.cos(a) * max;
          y = Math.sin(a) * max;
        }

        stick.style.left = x + "px";
        stick.style.top = y + "px";

        // Nilai -1 sampai 1 untuk pergerakan karakter
        joyX = x / max;
        joyY = y / max;
      };

      // Fungsi bantuan untuk menghentikan gerakan
      const handleEnd = () => {
        joyActive = false;
        joyX = 0;
        joyY = 0;
        stick.style.left = "0px";
        stick.style.top = "0px";
      };

      // Pasang Event untuk Touch (HP)
      joystick.addEventListener("touchstart", handleStart);
      window.addEventListener("touchmove", handleMove);
      window.addEventListener("touchend", handleEnd);

      // Pasang Event untuk Mouse (Laptop/Desktop)
      joystick.addEventListener("mousedown", handleStart);
      window.addEventListener("mousemove", handleMove);
      window.addEventListener("mouseup", handleEnd);

      joystick.addEventListener("touchstart", (e) => {
        joyActive = true;
        baseRect = joystick.getBoundingClientRect();
      });

      joystick.addEventListener("touchend", () => {
        joyActive = false;
        joyX = 0;
        joyY = 0;
        stick.style.left = "0px";
        stick.style.top = "0px";
      });

      joystick.addEventListener("touchmove", (e) => {
        if (!joyActive) return;
        let t = e.touches[0];

        let x = t.clientX - (baseRect.left + 60);
        let y = t.clientY - (baseRect.top + 60);

        const max = 45;
        if (Math.hypot(x, y) > max) {
          let a = Math.atan2(y, x);
          x = Math.cos(a) * max;
          y = Math.sin(a) * max;
        }

        stick.style.left = x + "px";
        stick.style.top = y + "px";

        joyX = x / max;
        joyY = y / max;
      });

      function levelSky() {
        const colors = ["#dcedc8", "#bbdefb", "#e1bee7", "#ffe0b2", "#f8bbd0"];
        scene.background = new THREE.Color(colors[(level - 1) % colors.length]);
      }

      function spawnClouds() {
        clouds = [];
        for (let i = 0; i < 6; i++) {
          const geo = new THREE.SphereGeometry(1.2, 16, 16);
          const mat = new THREE.MeshBasicMaterial({ color: 0xffffff });
          const cloud = new THREE.Mesh(geo, mat);
          cloud.position.set(
            Math.random() * 40 - 20,
            5 + Math.random() * 3,
            Math.random() * 40 - 20
          );
          cloud.userData.speed = 0.002 + Math.random() * 0.003;
          scene.add(cloud);
          clouds.push(cloud);
        }
      }

      function spawnDecor() {
        decor.forEach((d) => scene.remove(d));
        decor = [];

        for (let i = 0; i < 12; i++) {
          const geo =
            Math.random() > 0.5
              ? new THREE.ConeGeometry(0.3, 1)
              : new THREE.DodecahedronGeometry(0.3);

          const mat = new THREE.MeshPhongMaterial({ color: 0xa5d6a7 });
          const d = new THREE.Mesh(geo, mat);
          d.position.set(Math.random() * 40 - 20, 0.5, Math.random() * 40 - 20);
          scene.add(d);
          decor.push(d);
        }
      }

      function fadeTransition(callback) {
        const fade = document.createElement("div");
        fade.style.position = "fixed";
        fade.style.inset = 0;
        fade.style.background = "#ffffff";
        fade.style.opacity = 0;
        fade.style.transition = "opacity 1s ease";
        document.body.appendChild(fade);

        requestAnimationFrame(() => {
          fade.style.opacity = 1;
          setTimeout(() => {
            callback();
            fade.style.opacity = 0;
            setTimeout(() => fade.remove(), 800);
          }, 800);
        });
      }

      function spawnLevel() {
        orbs = [];
        levelSky();
        spawnDecor();

        scoreUI.textContent = score;
        levelUI.textContent = level;

        const orbCount = 4 + level;

        for (let i = 0; i < orbCount; i++) {
          const o = new THREE.Mesh(
            new THREE.SphereGeometry(0.4),
            new THREE.MeshPhongMaterial({ color: 0x81c784 })
          );
          o.position.set(Math.random() * 30 - 15, 0.6, Math.random() * 30 - 15);
          o.userData.angle = Math.random() * Math.PI * 2;
          scene.add(o);
          orbs.push(o);
        }
      }

      function breathingGuide() {
        let inhale = true;
        setInterval(() => {
          breathUI.style.opacity = 0.4;
          setTimeout(() => {
            breathUI.innerText = inhale
              ? "Tarik napas perlahanâ€¦ ðŸ«§"
              : "Hembuskanâ€¦ lepaskan bebanmu ðŸ˜Œ";
            breathUI.style.opacity = 1;
            inhale = !inhale;
          }, 500);
        }, 3000);
      }

      function dist(a, b) {
        return a.position.distanceTo(b.position);
      }

      function gameLoop() {
        requestAnimationFrame(gameLoop);

        const now = performance.now();
        const delta = (now - lastTime) / 16.6;
        lastTime = now;

        if (keys["w"] || keys["ArrowUp"] || joyY < -0.2) vel.z -= accel * delta;
        if (keys["s"] || keys["ArrowDown"] || joyY > 0.2)
          vel.z += accel * delta;
        if (keys["a"] || keys["ArrowLeft"] || joyX < -0.2)
          vel.x -= accel * delta;
        if (keys["d"] || keys["ArrowRight"] || joyX > 0.2)
          vel.x += accel * delta;

        vel.multiplyScalar(friction);
        player.position.add(vel);

        const target = new THREE.Vector3(
          player.position.x,
          2,
          player.position.z + 6
        );
        camera.position.lerp(target, 0.08);
        camera.lookAt(player.position);

        clouds.forEach((c) => {
          c.position.x += c.userData.speed;
          if (c.position.x > 25) c.position.x = -25;
        });

        orbs.forEach((o) => {
          o.userData.angle += 0.01;
          o.position.y = 0.6 + Math.sin(o.userData.angle) * 0.1;
        });

        orbs.forEach((o, i) => {
          if (dist(player, o) < 1) {
            scene.remove(o);
            orbs.splice(i, 1);
            score++;
            scoreUI.textContent = score;

            if (orbs.length == 0) {
              level++;
              fadeTransition(() => spawnLevel());
            }
          }
        });

        renderer.render(scene, camera);
      }
    </script>
  </body>
</html>
