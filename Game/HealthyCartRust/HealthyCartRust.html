<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Healthy Cart Rush</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
:root{
  --bg:#e8f5e9;
  --card:#ffffff;
  --text:#2e7d32;
  --accent:#66bb6a;
}
body{
  margin:0;overflow:hidden;
  background:var(--bg);
  font-family:Segoe UI,sans-serif;
  color:var(--text);
  transition:.4s;
}

.card{
  background:var(--card);
  padding:8px 14px;
  border-radius:16px;
  box-shadow:0 8px 18px rgba(0,0,0,.15);
}

#hud{position:fixed;inset:0;pointer-events:none}

#top{
  display:flex;
  justify-content:space-between;
  padding:12px 16px;
  font-weight:600;
}

#right{
  display:flex;
  gap:8px;
  pointer-events:auto;
}

#healthWrap{
  position:absolute;
  top:60px;
  left:16px;
  width:180px;
  height:10px;
  background:#0002;
  border-radius:10px;
  overflow:hidden;
}
#healthBar{
  height:100%;
  width:100%;
  background:#4caf50;
}

#msg{
  position:absolute;
  top:50%;left:50%;
  transform:translate(-50%,-50%);
  display:none;
}

#joy{
  position:absolute;
  bottom:20px;left:20px;
  width:90px;height:90px;
  border-radius:50%;
  background:#0002;
  pointer-events:auto;
}
#stick{
  width:40px;height:40px;
  background:white;
  border-radius:50%;
  position:absolute;
  top:25px;left:25px;
}

.screen{
  position:fixed;inset:0;
  background:var(--bg);
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:16px;
  z-index:10;
}

button{
  border:none;
  padding:10px 18px;
  border-radius:16px;
  background:var(--accent);
  color:white;
  cursor:pointer;
}
</style>
</head>

<body>

<!-- HOME -->
<div id="home" class="screen">
  <h1>ü•ó Healthy Cart Rush</h1>
  <button onclick="startGame()">Start Game</button>
</div>

<!-- END -->
<div id="end" class="screen" style="display:none">
  <h1>Game Over</h1>
  <p id="finalScore"></p>  <button onclick="startGame()">Restart</button>
  <button onclick="goHome()">Home</button>
</div>

<div id="hud">
  <div id="top">
    <div class="card">‚≠ê Score: <span id="score">0</span></div>

    <div id="right">
      <div class="card">üèÜ Lv <span id="level">1</span></div>
      <button onclick="startGame()">Restart</button>
      <button onclick="goHome()">Home</button>
    </div>
  </div>

  <div id="healthWrap">
    <div id="healthBar"></div>
  </div>

  <div id="msg" class="card"></div>
  <div id="joy"><div id="stick"></div></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
<script>
const GAME={
  run:false,
  score:0,
  level:1,
  move:0,
  speed:.25,
  health:100
};

const LEVEL_SCORE=150;
const THEMES=[
  ["#e8f5e9","#66bb6a"],
  ["#f1f8e9","#9ccc65"],
  ["#e0f2f1","#26a69a"],
  ["#ede7f6","#9575cd"],
  ["#fff8e1","#ffb300"]
];

const ctx=new (window.AudioContext||webkitAudioContext)();
function beep(f=600){
  ctx.resume();
  const o=ctx.createOscillator(),g=ctx.createGain();
  o.frequency.value=f;
  o.connect(g);g.connect(ctx.destination);
  g.gain.value=.08;
  o.start();o.stop(ctx.currentTime+.1);
}

let scene,camera,renderer,player,items=[];

init();loop();

function init(){
  scene=new THREE.Scene();
  camera=new THREE.PerspectiveCamera(60,innerWidth/innerHeight,.1,100);
  camera.position.set(0,3,6);
  camera.lookAt(0,1,0);

  renderer=new THREE.WebGLRenderer({antialias:true,alpha:true});
  renderer.setSize(innerWidth,innerHeight);
  document.body.appendChild(renderer.domElement);

  scene.add(new THREE.HemisphereLight(0xffffff,0x88aa88,1));

  const ground=new THREE.Mesh(
    new THREE.PlaneGeometry(20,200),
    new THREE.MeshStandardMaterial({color:0x66bb6a})
  );
  ground.rotation.x=-Math.PI/2;
  ground.position.z=-80;
  scene.add(ground);

  player=new THREE.Mesh(
    new THREE.BoxGeometry(1,1,1.4),
    new THREE.MeshStandardMaterial({color:0x4caf50})
  );
  player.position.y=.6;
  scene.add(player);

  setInterval(()=>GAME.run&&spawn(),600);
  controls();
}

function loop(){
  requestAnimationFrame(loop);
  if(!GAME.run) return;

  player.position.x+=GAME.move;
  player.position.x=Math.max(-3,Math.min(3,player.position.x));

  items.forEach((it,i)=>{
    it.position.z+=GAME.speed;
    if(it.position.distanceTo(player.position)<.8){
      hit(it.userData.good);
      scene.remove(it);items.splice(i,1);
    }
    if(it.position.z>6){
      scene.remove(it);items.splice(i,1);
    }
  });

  renderer.render(scene,camera);
}

function spawn(){
  const isGood=Math.random()>0.6;
  const emoji=isGood
    ? ["üçé","ü•¶","ü•ï","üçå"][Math.random()*4|0]
    : ["üçî","üçü","ü•§","üçï"][Math.random()*4|0];

  const c=document.createElement("canvas");
  c.width=c.height=128;
  const g=c.getContext("2d");
  g.font="90px serif";
  g.textAlign="center";
  g.textBaseline="middle";
  g.fillText(emoji,64,70);

  const sp=new THREE.Sprite(
    new THREE.SpriteMaterial({map:new THREE.CanvasTexture(c)})
  );
  sp.scale.set(.8,.8,1);
  sp.position.set(Math.random()*6-3,.4,-20);
  sp.userData.good=isGood;
  scene.add(sp);items.push(sp);
}

function hit(good){
  if(good){
    GAME.score+=10;
    if(GAME.score>=GAME.level*LEVEL_SCORE) levelUp();
    beep(800);
  }else{
    GAME.health-=20;
    beep(200);
  }
  updateUI();
}

function levelUp(){
  GAME.level++;
  popup("üéâ LEVEL UP!");
  applyTheme();
}

function applyTheme(){
  const t=THEMES[GAME.level-1]||THEMES[4];
  document.documentElement.style.setProperty("--bg",t[0]);
  document.documentElement.style.setProperty("--accent",t[1]);
}

function updateUI(){
  score.textContent=GAME.score;
  level.textContent=GAME.level;
  healthBar.style.width=GAME.health+"%";
  if(GAME.health<=0) gameOver();
}

function gameOver(){
  GAME.run=false;
  end.style.display="flex";
  finalScore.textContent="Score: "+GAME.score;
}

function popup(t){
  msg.textContent=t;
  msg.style.display="block";
  setTimeout(()=>msg.style.display="none",800);
}

function controls() {
  // Kontrol Keyboard
  onkeydown = e => {
    // Nilai dikurangi dari 0.15 menjadi 0.08 agar lebih pelan
    if (e.key === "ArrowLeft") GAME.move = -.08;
    if (e.key === "ArrowRight") GAME.move = .08;
  };
  onkeyup = () => GAME.move = 0;

  // Kontrol Joystick
  let active = false;
  const joyCenter = 45; 

  const handleStart = (e) => {
    active = true;
    handleMove(e);
  };

  const handleMove = (e) => {
    if (!active) return;
    
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const rect = joy.getBoundingClientRect();
    let dx = clientX - (rect.left + joyCenter);
    dx = Math.max(-30, Math.min(30, dx));
    
    stick.style.left = (25 + dx) + "px";
    
    // PEMBATAS KECEPATAN:
    // Angka pembagi dinaikkan dari 150 ke 400 agar gerakan lebih halus/lambat
    GAME.move = dx / 400; 
  };

  const handleEnd = () => {
    active = false;
    GAME.move = 0;
    stick.style.left = "25px";
  };

  joy.addEventListener('touchstart', handleStart);
  window.addEventListener('touchmove', handleMove);
  window.addEventListener('touchend', handleEnd);

  joy.addEventListener('mousedown', handleStart);
  window.addEventListener('mousemove', handleMove);
  window.addEventListener('mouseup', handleEnd);
}

function startGame(){
  home.style.display="none";
  end.style.display="none";
  GAME.run=true;
  GAME.score=0;
  GAME.level=1;
  GAME.health=100;
  items.forEach(i=>scene.remove(i));
  items=[];
  applyTheme();
  updateUI();
}

function goHome(){
  location.reload();
}
</script>
</body>
</html>
